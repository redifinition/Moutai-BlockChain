# 区块链茅台酒溯源的简单实现

> 《网络安全》课程 ———— 区块链茅台酒溯源的简单实现
>
> 学号： 2333091 姓名： 梁乔
>
> 前端：`Vue2.x`+`vue-element-admin` 核心代码量：800行左右
>
> 后端：`Flask`   核心代码量：500行左右
>
> 仓库地址：https://github.com/redifinition/Moutai-BlockChain

[TOC]



## 1 项目简介

  本项目旨在通过前沿的区块链技术构建一个茅台酒溯源系统，为茅台酒的生产、运输及销售过程提供**透明可追溯的管理平台**。本项目均采用简单的前后端框架实现了区块链的一些核心要素，包括**数据的一致性，不可篡改性，透明性，可追溯性**。

本项目的应用场景包括三方面：对于**消费者**而言，可以验证购买的茅台酒的真实性和产地，了解产品的生产、物流过程；对于**生产商**而言，可以监控产品的流通路径，管理生产质量；对于**监管机构**而言，则可以实时追踪产品流通情况，有效预防假冒伪劣产品的流入市场。

### 1.1 技术栈

本项目为Web平台，前端采用`Vue2.x`框架进行开发，结合`vue-element-admin`中台模版，为用户提供了一个美观、响应式的界面。用户可以通过前端界面查询茅台酒的生产、物流、销售等详细信息，实现从生产到消费的全过程溯源。

后端使用`Flask`框架，负责处理前端发送的请求、执行区块链交易记录、数据查询等功能。通过构建安全可靠的后端服务，确保了数据的真实性和不可篡改性。

在本项目中，为了在单一计算机上模拟区块链技术的**分布式网络特性**，采取了一种简便的方法，即在同一台机器上启动多个后端实例，每个实例运行在不同的**端口**上。这样，每个运行中的后端实例就好比是一个独立的网络节点，共同构成了一个简化版的分布式区块链网络。这种模拟方法使得我们可以在不依赖于实际分布式硬件环境的情况下，验证和展示区块链技术的关键特性，如数据一致性、不可篡改性和去中心化。为了实现这一目标，项目后端启动多个`Flask`服务实例，每个实例都拥有自己的API接口和逻辑处理模块，就如同一个独立的区块链节点。与此同时，项目允许用户动态配置和选择与之交互的后端节点。用户可以通过前端界面**选择特定的后端实例**（节点）进行数据查询、提交交易等操作，这些操作随后由选定的后端节点处理并反映在区块链网络中。通过这种方式，前端界面成为了用户与模拟的区块链网络交互的桥梁，使用户能够体验到真实的分布式区块链网络操作。

对于数据存储方面，本项目预留了扩展接口，可方便的接入如`sqlite`，`Redis`等轻量级数据库或者`MySQL`等关系型数据库。由于数据存储不属于本课程和本项目的重点，本项目未进行实现，**将数据存储作为项目的后续扩展**。

### 1.2 项目架构图

本项目的基本架构如下图所示：

<img src="https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.43.37.png" alt="截屏2024-04-10 15.43.37" style="zoom: 50%;" />

## 2 系统功能

本系统主要实现了区块链配置，区块链查询，新增区块，新增交易和茅台酒溯源五个核心功能点。

### 2.1 区块链配置

对于区块链配置而言，主要包括以下三个子功能：

- **选择节点**：此功能允许用户从现有的节点网络中挑选特定的节点进行交互。用户通过浏览当前可用的节点列表选择节点。选定节点后，用户的交易和查询请求将通过这个节点进行，从而能够访问该节点所持有的区块链数据副本。
- 注册节点：用户能够向指定的区块链网络添加新的节点。在完成新节点的合法性验证后，新节点将成为网络的一部分，并开始接收和存储区块数据，从而确保了整个网络的**数据一致性和可靠性**。
- **区块链同步**：同步不同节点的区块链副本，将一个节点上的区块链数据副本更新至最新状态，以实现节点间的一致性。

![截屏2024-04-10 15.45.39](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.45.39.png)

### 2.2 区块链查询

该功能能够查看整个区块链副本的基本信息，包括时间戳，哈希值，前一区块的哈希值，交易数和详细的交易记录。

![截屏2024-04-10 15.54.41](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.54.41.png)

![截屏2024-04-10 15.54.22](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.54.22.png)

### 2.3 新增区块

该功能实现在当前节点的区块链副本的末尾新增一个区块。在新增区块后，区块链副本中缓存的交易记录会新增到该区块上。新增区块无需指定任何信息，这保证了区块和交易之间的分离。

![截屏2024-04-10 15.55.45](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.55.45.png)

### 2.4 新增交易

该功能实现新增包括生产，物流和销售的三个类型的交易，每个交易通过表单填写完成，每个字段有完善的验证机制。新增的交易会加入到当前区块链副本的缓冲区中，等待下一个区块建立后加入到区块中。

> 生产交易

<img src="https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.57.06.png" alt="截屏2024-04-10 15.57.06" style="zoom: 33%;" />

> 物流交易

<img src="https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.59.08.png" alt="截屏2024-04-10 15.59.08" style="zoom:33%;" />

> 销售交易

<img src="https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2015.59.42.png" alt="截屏2024-04-10 15.59.42" style="zoom:33%;" />

### 2.5 茅台酒溯源

该功能实现了每瓶茅台酒从生产到运输到交易的全链路溯源。由于每个茅台酒具有唯一的产品ID，因此通过产品ID进行搜索会从当前区块链副本的所有区块进行搜索，返回当前茅台酒的所有交易信息，实现信息的透明可靠。

比如下图产品ID为120832的茅台酒，其交易信息只有运输交易和销售交易，却没有生产交易信息，其溯源信息表明该茅台酒的真实性有待考证。

![截屏2024-04-10 16.00.53](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2016.00.53.png)

## 3 系统实现

### 3.1 区块设计

区块链的核心为单个区块的设计。为了保证区块功能与交易信息的分离，本系统的区块类只包含最基本的信息。`Block`类的设计如下：

| 字段名        | 字段类型 | 字段含义                                  |
| ------------- | -------- | ----------------------------------------- |
| index         | Integer  | 区块的索引                                |
| timestamp     | String   | 区块的时间戳，格式为"YYYY-MM-DD HH:MM:SS" |
| transactions  | List     | 区块中包含的交易列表                      |
| previous_hash | String   | 前一个区块的哈希值                        |
| hash          | String   | 当前区块的哈希值                          |

| 法名             | 方法作用                                                     |
| ---------------- | ------------------------------------------------------------ |
| `__init__`       | 构造函数，初始化一个新的区块实例                             |
| `calculate_hash` | 计算区块的哈希值，使用区块的索引、时间戳、交易列表、前一个区块的哈希值和自身的哈希值 |
| `to_dict`        | 将区块的信息转换为字典格式，方便存储或传输                   |
| `dict_to_block`  | 静态方法，将字典格式的数据转换回`Block`类的实例              |

### 3.2 区块链设计

`Blockchain`类设计为区块链网络的核心，提供了一组API来管理和操作区块链。该类通过`chain`列表维护一个公开的、不可变的区块记录，每个区块包含一系列已确认的交易。通过`currentTransaction`列表，它管理等待记录到区块链中的交易信息。为了支持区块链网络的分布式特性，`Blockchain`类使用`nodes`集合来记录网络中的所有节点。这使得节点可以互相通信、共享数据，从而保持区块链的全网一致性。此外，`authorities`集合用于维护网络中的权威节点，这些节点在某些情况下可以进行特殊操作或验证。

类提供的方法如`register_node`、`resolve_conflicts`等，允许动态地添加新节点、解决数据冲突，确保整个网络达到一致状态。`new_block`和`new_transaction`方法分别用于创建新区块和新交易，是区块链数据记录和更新的基本操作。

通过`valid_chain`方法，`Blockchain`类能够验证区块链的完整性和有效性，这对于维护区块链的安全和可靠性至关重要。`last_block`属性则提供了快速访问区块链最新状态的方式。

| 字段名             | 字段类型 | 字段含义                                                     |
| ------------------ | -------- | ------------------------------------------------------------ |
| chain              | List     | 存储区块链中所有区块的列表，代表区块链本身。                 |
| currentTransaction | List     | 存储等待被写入新区块的已确认交易信息。                       |
| nodes              | Set      | 存储区块链网络中发现的所有节点信息，用于网络通信和数据同步。 |
| authorities        | Set      | 存储区块链网络中的权威节点信息，用于特定的链上操作或验证。   |

| 方法名              | 方法作用                                                     |
| ------------------- | ------------------------------------------------------------ |
| `__init__`          | 类的构造函数，初始化一个空的区块链、交易列表、节点集合和权威节点集合，并创建创世区块。 |
| `register_node`     | 向区块链网络中添加新节点，用于网络扩展和节点间通信。         |
| `valid_chain`       | 检查给定的区块链是否有效，即验证区块和交易的完整性和一致性。 |
| `resolve_conflicts` | 解决区块链网络中的节点冲突，通过选择最长的有效链来保持网络一致性。 |
| `new_block`         | 创建一个新区块并将其添加到区块链中。                         |
| `new_transaction`   | 向区块链中添加一笔新的交易。                                 |
| `last_block`        | 获取区块链中的最后一个区块。                                 |

### 3.3 交易设计

`Transaction`类是一个基础交易类，定义了所有交易共有的属性和方法，如时间戳（`timestamp`）、产品ID（`product_id`）和交易ID（`transaction_id`）。交易ID通过`generate_transaction_id`方法自动生成，确保了每笔交易的唯一性。

`ProductionTransaction`类继承自`Transaction`，增加了特定于生产交易的字段，如批次号（`batch_number`）、生产日期（`production_date`）、工厂名称（`factory`）和原材料或生产地点（`origin_place`）。这些字段允许更详细地追踪产品的生产信息。

`LogisticsTransaction`类同样继承自`Transaction`，用于记录物流过程中的交易信息，包括发货地址（`from_address`）、收货地址（`to_address`）、承运商（`carrier`）、追踪号（`tracking_number`）、起始时间（`start_time`）、结束时间（`end_time`）和当前状态（`status`）。`update_status`方法允许更新物流状态和结束时间。

`SaleTransaction`类关注销售过程中的交易，包括卖方（`seller`）、买方（`buyer`）和交易价格（`price`）。

| 字段名          | 字段类型 | 字段含义                   |
| --------------- | -------- | -------------------------- |
| timestamp       | String   | 交易的时间戳               |
| product_id      | Integer  | 交易涉及的产品ID           |
| transaction_id  | String   | 交易的唯一标识符           |
| batch_number    | Integer  | 生产交易的批次号           |
| production_date | String   | 生产交易的生产日期         |
| factory         | String   | 生产交易的工厂名称         |
| origin_place    | String   | 生产交易的原材料或生产地点 |
| from_address    | String   | 物流交易的发货地址         |
| to_address      | String   | 物流交易的收货地址         |
| carrier         | String   | 物流交易的承运商           |
| tracking_number | Integer  | 物流交易的追踪号           |
| start_time      | String   | 物流交易的起始时间         |
| end_time        | String   | 物流交易的结束时间         |
| status          | String   | 物流交易的当前状态         |
| seller          | String   | 销售交易的卖方             |
| buyer           | String   | 销售交易的买方             |
| price           | Float    | 销售交易的价格             |

| 方法名                    | 方法作用                                         |
| ------------------------- | ------------------------------------------------ |
| `__init__`                | 构造函数，初始化交易实例                         |
| `to_dict`                 | 将交易的详细信息转换成字典格式                   |
| `generate_transaction_id` | 生成交易的唯一标识符                             |
| `update_status`           | （仅限`LogisticsTransaction`）更新物流交易的状态 |

### 3.4 接口设计

根据以上的类设计和前端的接口调用需求，本系统设计了以下几个可调用接口：

| 接口名称          | 方法类型 | 参数                                   | 接口描述                                           | 调用示例                                                     |
| ----------------- | -------- | -------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| /transactions/new | POST     | JSON数据（包括type及其他交易所需字段） | 创建一个新的交易，并将其加入到待挖掘的区块中       | `curl -X POST -H "Content-Type: application/json" -d '{"type": "sale", "timestamp": "2024-04-10", "product_id": 123}' http://localhost:5001/transactions/new` |
| /mine             | GET      | 无                                     | 触发挖掘新区块的过程，并将待处理的交易记录到区块中 | `curl http://localhost:5001/mine`                            |
| /chain            | GET      | 无                                     | 返回区块链网络中的完整区块链信息                   | `curl http://localhost:5001/chain`                           |
| /nodes/register   | POST     | JSON数据（nodes: 节点地址列表）        | 向区块链网络注册新的节点                           | `curl -X POST -H "Content-Type: application/json" -d '{"nodes": ["http://192.168.0.5:5000"]}' http://localhost:5001/nodes/register` |
| /nodes/resolve    | GET      | 无                                     | 通过网络中最长的链来解决节点间的冲突               | `curl http://localhost:5001/nodes/resolve`                   |
| /product/history  | GET      | product_id (通过URL参数传递)           | 根据产品ID查询产品的交易历史                       | `curl http://localhost:5001/product/history?product_id=123`  |

## 4 项目运行

本项目现已开源，仓库地址为：https://github.com/redifinition/Moutai-BlockChain，在克隆项目后，通过以下步骤进行项目的运行：

####  后端运行

进入后端项目文件夹：

```bash
cd backend
```

分别运行两个后端服务示例，端口为5001，5002（若提示被占用则可更改端口运行）:

```bash
python app-1.py
python app-2.py
```

添加示例数据

```bash
python pre_data_generation.py
```

每个后端实例运行后将会显示如下界面：

![截屏2024-04-10 16.25.28](https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2016.25.28.png)

#### 前端运行：

进入前端文件夹：

```bash
cd frontend
```

安装依赖项：

```bash
npm install
```

启动前端：

```bash
npm run serve
```

前端启动后将会显示如下界面：

<img src="https://joes-bucket.oss-cn-shanghai.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-04-10%2016.27.44.png" alt="截屏2024-04-10 16.27.44" style="zoom: 50%;" />

## 5 总结

在全球化的商业环境中，茅台酒作为中国高端白酒的代表，其溯源问题变得日益重要。由于市场上假冒伪劣产品的流通，消费者对产品真实性的需求日益增加。基于这一背景，本项目旨在利用区块链技术，为茅台酒提供一个透明、安全、不可篡改的溯源平台。

本项目前端采用`Vue2.x`框架结合`vue-element-admin`模板开发，提供了一个友好的用户界面。后端则基于`Flask`框架实现，利用RESTful API与前端进行交互，构建了一个简单的区块链网络来存储茅台酒的交易和生产信息。

通过实现新交易、挖矿、注册节点、解决节点冲突等接口，项目模拟了区块链网络的核心功能，包括数据的加密存储、节点间的通信和数据同步等。同时，项目还提供了查询产品历史的接口，使得每一瓶茅台酒从生产到销售的每一个环节都能被追踪和验证。本项目具有如下特点：

- **分布式数据存储**：通过在单机上模拟多个节点的方式，项目成功展示了区块链的分布式数据存储特性，保证了数据的安全性和一致性。
- **数据不可篡改**：每一笔交易信息一旦被加入到区块链中，就无法被更改或删除，保障了交易数据的真实性。
- **透明度**：所有交易数据对参与方公开，每个环节都可以被追踪和验证，大大增强了供应链的透明度。
- **易用性**：借助`Vue`和`Flask`的强大功能，项目提供了简洁明了的用户界面和高效稳定的后端服务。

通过本项目的开发与实现，我们验证了区块链技术在溯源领域的应用价值。未来，随着技术的进步和应用的深入，区块链有望为更多行业带来创新和变革，尤其是在确保数据真实性和提高系统透明度方面。